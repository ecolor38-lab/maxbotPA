import Anthropic from '@anthropic-ai/sdk';
import OpenAI from 'openai';

export class AISummarizer {
  constructor(config) {
    this.config = config;
    this.anthropic = config.anthropic.apiKey ? new Anthropic({ apiKey: config.anthropic.apiKey }) : null;
    this.openai = config.openai.apiKey ? new OpenAI({ apiKey: config.openai.apiKey }) : null;
  }

  async generateSummary(articles) {
    console.log('ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–∞–º–º–∞—Ä–∏ –∏–∑ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π...');

    const articlesText = articles.map((article, index) =>
      `${index + 1}. ${article.title}\n   –ò—Å—Ç–æ—á–Ω–∏–∫: ${article.source}\n   ${article.snippet || ''}\n`
    ).join('\n');

    const prompt = this.createPrompt(articlesText);

    let summary;
    try {
      if (this.anthropic) {
        summary = await this.generateWithClaude(prompt);
      } else if (this.openai) {
        summary = await this.generateWithOpenAI(prompt);
      } else {
        console.log('‚ö†Ô∏è API –∫–ª—é—á–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-–∫–æ–Ω—Ç–µ–Ω—Ç');
        summary = this.generateDemoSummary(articles);
      }
    } catch (error) {
      console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ API, –∏—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-–∫–æ–Ω—Ç–µ–Ω—Ç');
      summary = this.generateDemoSummary(articles);
    }

    console.log('‚úÖ –°–∞–º–º–∞—Ä–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ');
    return summary;
  }

  createPrompt(articlesText) {
    const language = this.config.language === 'ru' ? '—Ä—É—Å—Å–∫–æ–º' : '–∞–Ω–≥–ª–∏–π—Å–∫–æ–º';

    return `–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∂—É—Ä–Ω–∞–ª–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø—Å–æ—Ä–∏–∞—Ç–∏—á–µ—Å–∫–æ–º –∞—Ä—Ç—Ä–∏—Ç–µ –∏ –Ω–æ–≤—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö.

–ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç–∞—Ç–µ–π —Å–æ–∑–¥–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ –Ω–∞ ${language} —è–∑—ã–∫–µ:

${articlesText}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É:
1. –û–±—ä–µ–º: 800-1200 —Å–∏–º–≤–æ–ª–æ–≤
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - –ü—Ä–∏–≤–ª–µ–∫–∞—é—â–∏–π –≤–Ω–∏–º–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫
   - –ö—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Ç–µ–º—ã
   - 3-5 –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
   - –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º)
3. –°—Ç–∏–ª—å: –Ω–∞—É—á–Ω–æ-–ø–æ–ø—É–ª—è—Ä–Ω—ã–π, –¥–æ—Å—Ç—É–ø–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
4. –£–ø–æ–º—è–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
5. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (2-3 —à—Ç—É–∫–∏ –º–∞–∫—Å–∏–º—É–º)
6. –ò–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞, –æ–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã

–ù–ï –í–ö–õ–Æ–ß–ê–ô —Ö–µ—à—Ç–µ–≥–∏ –≤ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ - –æ–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ.

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.`;
  }

  async generateWithClaude(prompt) {
    try {
      const message = await this.anthropic.messages.create({
        model: this.config.anthropic.model,
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: prompt
        }]
      });

      return message.content[0].text;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å Claude:', error.message);
      throw error;
    }
  }

  async generateWithOpenAI(prompt) {
    try {
      const completion = await this.openai.chat.completions.create({
        model: this.config.openai.model,
        messages: [{
          role: 'system',
          content: '–¢—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∂—É—Ä–Ω–∞–ª–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø—Å–æ—Ä–∏–∞—Ç–∏—á–µ—Å–∫–æ–º –∞—Ä—Ç—Ä–∏—Ç–µ.'
        }, {
          role: 'user',
          content: prompt
        }],
        max_tokens: 2000,
        temperature: 0.7
      });

      return completion.choices[0].message.content;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å OpenAI:', error.message);
      throw error;
    }
  }

  async generateImagePrompt(postText) {
    console.log('üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');

    // –ü—Ä–æ—Å—Ç–æ–π fallback –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    const keywords = this.extractKeywords(postText);
    const fallbackPrompt = `Professional medical infographic about ${keywords}. Modern scientific illustration with blue gradient background, molecules, cells, medical symbols, and technology icons. Horizontal layout, clean design, no text, no people.`;

    const prompt = `–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —Å–æ–∑–¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –¥–æ 100 —Å–ª–æ–≤) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏.

–ü–æ—Å—Ç:
${postText}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Ç–µ–º–∞—Ç–∏–∫–∞, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å, —Å–∏–Ω–∏–π/–±–µ–ª—ã–π —Ü–≤–µ—Ç–∞, –±–µ–∑ –ª—é–¥–µ–π, —Ñ–æ–∫—É—Å –Ω–∞ –º–æ–ª–µ–∫—É–ª–∞—Ö –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö.
–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.`;

    try {
      let imagePrompt;
      if (this.anthropic) {
        imagePrompt = await this.generateWithClaude(prompt);
      } else if (this.openai) {
        imagePrompt = await this.generateWithOpenAI(prompt);
      } else {
        console.log('‚ö†Ô∏è API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç');
        return fallbackPrompt;
      }

      console.log('‚úÖ –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ AI');
      return imagePrompt;
    } catch (error) {
      console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ AI, –∏—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç');
      return fallbackPrompt;
    }
  }

  extractKeywords(text) {
    const medicalKeywords = [
      '–∞—Ä—Ç—Ä–∏—Ç', 'arthritis', '–ø—Å–æ—Ä–∏–∞—Ç–∏—á–µ—Å–∫–∏–π', 'psoriatic',
      '–ª–µ—á–µ–Ω–∏–µ', 'treatment', '–ø—Ä–µ–ø–∞—Ä–∞—Ç', 'drug', 'medication',
      'AI', '–ò–ò', '–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç', '–∫–ª–∏–Ω–∏—á–µ—Å–∫', 'clinical',
      '—Ç–µ—Ä–∞–ø–∏—è', 'therapy', '–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π', 'biologic'
    ];

    const found = [];
    for (const keyword of medicalKeywords) {
      if (text.toLowerCase().includes(keyword.toLowerCase())) {
        found.push(keyword);
      }
    }

    return found.slice(0, 3).join(', ') || 'arthritis treatment and medical innovation';
  }

  generateDemoSummary(articles) {
    return `üî¨ –ü—Ä–æ—Ä—ã–≤ –≤ –ª–µ—á–µ–Ω–∏–∏ –ø—Å–æ—Ä–∏–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—Ä—Ç—Ä–∏—Ç–∞: —á—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ 2025 –≥–æ–¥—É?

–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –Ω–æ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã –≤ –±–æ—Ä—å–±–µ —Å –ø—Å–æ—Ä–∏–∞—Ç–∏—á–µ—Å–∫–∏–º –∞—Ä—Ç—Ä–∏—Ç–æ–º. –í–æ—Ç –∫–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è—é—Ç –∂–∏–∑–Ω—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤:

üíä –ù–æ–≤—ã–µ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã
–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è III —Ñ–∞–∑—ã –ø–æ–∫–∞–∑–∞–ª–∏ –≤–ø–µ—á–∞—Ç–ª—è—é—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: –Ω–æ–≤—ã–π –∏–Ω–≥–∏–±–∏—Ç–æ—Ä IL-17 —É–ª—É—á—à–∞–µ—Ç —Å–∏–º–ø—Ç–æ–º—ã —É 78% –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —É–∂–µ —á–µ—Ä–µ–∑ 12 –Ω–µ–¥–µ–ª—å —Ç–µ—Ä–∞–ø–∏–∏. –ü—Ä–µ–ø–∞—Ä–∞—Ç –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª –Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã—Å–æ–∫—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–æ –∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

ü§ñ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–∂–µ –∑–¥–æ—Ä–æ–≤—å—è
–£—á–µ–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∏ AI-–∞–ª–≥–æ—Ä–∏—Ç–º, –∫–æ—Ç–æ—Ä—ã–π —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 85% –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏–µ –∞—Ä—Ç—Ä–∏—Ç–∞ —É –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ø—Å–æ—Ä–∏–∞–∑–æ–º –Ω–∞ 5 –ª–µ—Ç –≤–ø–µ—Ä–µ–¥. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–æ–ª–µ–µ 200 –±–∏–æ–º–∞—Ä–∫–µ—Ä–æ–≤, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ª–µ—á–µ–Ω–∏–µ –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤.

üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
–ì–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø–æ–º–æ–≥–∞–µ—Ç –≤—Ä–∞—á–∞–º –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞, —É–≤–µ–ª–∏—á–∏–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ç–µ—Ä–∞–ø–∏—é –Ω–∞ 40%.

–≠—Ç–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–∞—é—Ç —Ä–µ–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–¥—É –º–∏–ª–ª–∏–æ–Ω–∞–º –ª—é–¥–µ–π, –∂–∏–≤—É—â–∏—Ö —Å –ø—Å–æ—Ä–∏–∞—Ç–∏—á–µ—Å–∫–∏–º –∞—Ä—Ç—Ä–∏—Ç–æ–º. –†–∞–Ω–Ω—è—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –¥–µ–ª–∞—é—Ç –±–æ–ª–µ–∑–Ω—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–π.

üí¨ –ñ–∏–≤–µ—Ç–µ —Å –ü—Å–ê? –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö!`;
  }
}
